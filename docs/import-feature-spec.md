# インポート機能仕様書

## 概要

Lightroomライクなメディアインポート機能を実装し、iPhone、SDカード、外部ドライブなどから写真・動画を整理しながら取り込む。

## 主要機能

### 1. デバイス検出と接続

#### 対応デバイス
- **iPhone/iPad** (MTP/PTP経由)
- **Androidデバイス** (MTP経由)
- **SDカード** (リムーバブルドライブ)
- **USBメモリ/外部HDD**
- **デジタルカメラ** (PTP/MTP)
- **ローカルフォルダ**

#### デバイス検出フロー
1. システムイベント監視でデバイス接続を検出
2. デバイス種別を自動判別
3. メディアファイルをスキャン
4. サムネイル生成とプレビュー表示

### 2. インポート画面UI

#### レイアウト構成
```
┌─────────────────────────────────────────────────┐
│  ツールバー                                      │
│  [デバイス選択] [表示切替] [選択] [フィルタ]      │
├───────────────┬─────────────────────────────────┤
│               │                                 │
│  ソースパネル  │     メディアグリッド              │
│               │  ┌────┐ ┌────┐ ┌────┐        │
│  📱 iPhone    │  │    │ │    │ │    │        │
│  💾 SDカード   │  └────┘ └────┘ └────┘        │
│  📁 フォルダ   │  ┌────┐ ┌────┐ ┌────┐        │
│               │  │    │ │    │ │    │        │
│               │  └────┘ └────┘ └────┘        │
├───────────────┼─────────────────────────────────┤
│               │                                 │
│  整理オプション │     インポート先設定              │
│               │                                 │
└───────────────┴─────────────────────────────────┘
```

#### UI要素詳細

##### ソースパネル（左側）
- デバイス一覧表示
- 接続状態インジケータ
- 容量表示（使用済み/空き容量）
- フォルダツリー表示

##### メディアグリッド（中央）
- サムネイル表示（可変サイズ）
- チェックボックスで選択
- メタデータオーバーレイ
  - ファイル名
  - 撮影日時
  - ファイルサイズ
  - 画像サイズ/動画時間
- ステータスバッジ
  - ✅ インポート済み
  - 🔄 重複
  - ⭐ お気に入り

##### 詳細パネル（右側/下部切替可能）
- プレビュー（大サイズ）
- EXIF情報表示
- ヒストグラム
- タグ/レーティング設定

### 3. 整理機能

#### 自動整理ルール
```dart
class OrganizeRule {
  // フォルダ構造テンプレート
  String folderTemplate; // 例: "{year}/{month}/{day}"
  
  // ファイル名テンプレート
  String fileNameTemplate; // 例: "{date}_{time}_{camera}_{sequence}"
  
  // グループ化オプション
  GroupBy groupBy; // 日付、イベント、場所、カメラ
  
  // フィルタ条件
  List<FilterCondition> filters;
}
```

#### 整理オプション
1. **日付別整理**
   - 年/月/日階層
   - カスタム日付フォーマット
   - タイムゾーン考慮

2. **イベント別整理**
   - 撮影間隔でグループ化
   - 場所情報でグループ化
   - 手動イベント作成

3. **デバイス別整理**
   - カメラモデル別
   - レンズ別
   - 撮影者別

4. **メディアタイプ別**
   - 写真/動画分離
   - RAW/JPEG分離
   - フォーマット別

### 4. 重複検出と処理

#### 重複検出アルゴリズム
1. **ハッシュベース**
   - MD5/SHA256によるバイト一致
   - 高速・確実

2. **メタデータベース**
   - 撮影日時 + カメラ情報
   - ファイルサイズ

3. **画像類似度**（オプション）
   - パーセプチュアルハッシュ
   - 類似度閾値設定可能

#### 重複処理オプション
- スキップ
- 上書き
- 別名保存
- より高品質を選択
- ユーザー確認

### 5. インポート処理

#### 処理フロー
```dart
class ImportProcess {
  // 1. 前処理
  Future<void> prepare() async {
    await scanMedia();
    await generateThumbnails();
    await detectDuplicates();
  }
  
  // 2. メイン処理
  Future<void> execute() async {
    await copyFiles();
    await applyMetadata();
    await updateDatabase();
  }
  
  // 3. 後処理
  Future<void> finalize() async {
    await generatePreviews();
    await createBackup();
    await notifyCompletion();
  }
}
```

#### パフォーマンス最適化
- **並列処理**: 複数ファイル同時コピー
- **プログレッシブ表示**: コピー完了分から順次表示
- **バックグラウンド処理**: UIをブロックしない
- **キャッシュ**: サムネイル・メタデータキャッシュ

### 6. メタデータ処理

#### 読み取り項目
- EXIF（カメラ、レンズ、露出情報）
- IPTC（著作権、キーワード）
- XMP（レーティング、ラベル）
- GPS（位置情報）
- 動画メタデータ（コーデック、ビットレート）

#### 編集可能項目
- タイトル/説明
- キーワード/タグ
- レーティング（1-5星）
- カラーラベル
- 著作権情報

### 7. プリセット管理

#### インポートプリセット
```dart
class ImportPreset {
  String name;
  OrganizeRule organizeRule;
  MetadataTemplate metadata;
  DuplicateHandling duplicateHandling;
  List<String> targetFolders;
  
  // プリセット保存/読み込み
  void save();
  static ImportPreset load(String name);
}
```

### 8. 履歴とログ

#### インポート履歴
- インポート日時
- ソースデバイス
- インポートファイル数
- 合計サイズ
- 適用ルール

#### エラーハンドリング
- ファイル毎のステータス追跡
- エラー内容の詳細記録
- リトライ機能
- エラーレポート出力

## 技術実装

### Flutter パッケージ使用
```yaml
dependencies:
  # デバイス検出
  device_info_plus: ^9.0.0
  usb_serial: ^0.5.0
  
  # ファイル操作
  file_picker: ^6.0.0
  desktop_drop: ^0.4.0
  
  # メディア処理
  photo_manager: ^3.0.0
  image: ^4.0.0
  exif: ^3.3.0
  
  # UI
  flutter_staggered_grid_view: ^0.7.0
  photo_view: ^0.14.0
  
  # データベース
  sqflite: ^2.3.0
  
  # 並列処理
  isolate_pool: ^1.0.0
```

### プラットフォーム別実装
- **Windows**: WPD API for MTP/PTP
- **macOS**: ImageCapture framework
- **Linux**: libmtp, gphoto2

## UI/UXガイドライン

### デザイン原則
1. **Lightroomライク**: 馴染みのあるインターフェース
2. **効率性**: キーボードショートカット充実
3. **視認性**: ダークテーマデフォルト
4. **レスポンシブ**: ウィンドウサイズに適応

### カラースキーム
- 背景: #1e1e1e（ダークグレー）
- アクセント: #007ACC（ブルー）
- 選択: #3E3E3E
- テキスト: #CCCCCC

### アニメーション
- サムネイルフェードイン
- プログレスバースムーズ
- デバイス接続アニメーション

## パフォーマンス目標

- サムネイル生成: 100枚/秒
- ファイルコピー: 100MB/秒以上
- メモリ使用: 500MB以下
- 起動時間: 3秒以内